<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Выбор ОС</title>
  
  <!-- Подключение Telegram WebApp JS API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    @font-face {
      font-family: 'SF-Pro-Display-Regular';
      src: url('SF-Pro-Display-Regular.otf') format('opentype');
      font-weight: 100;
      font-style: normal;
    }
    @font-face {
      font-family: 'SF-Pro-Display-Bold';
      src: url('SF-Pro-Display-Bold.otf') format('opentype');
      font-weight: 100;
      font-style: normal;
    }
    @font-face {
      font-family: 'SF-Pro-Display-Thin';
      src: url('SF-Pro-Display-Thin.otf') format('opentype');
      font-weight: 100;
      font-style: normal;
    }
    @font-face {
      font-family: 'SF-Pro-Display-Medium';
      src: url('SF-Pro-Display-Medium.otf') format('opentype');
      font-weight: 100;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      font-family: 'SF-Pro-Display-Regular', -apple-system,
                   BlinkMacSystemFont, "Segoe UI", Roboto,
                   "Helvetica Neue", Arial, sans-serif;
      overflow: hidden;
    }

    /* Загрузочный экран */
    #loader {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.4s ease;
    }
    #loader img {
      max-width: 200px;
      width: auto;
      height: auto;
    }

    /* Контейнер всех экранов */
    #appWrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .screen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      box-sizing: border-box;
    }
    .screen.active {
      display: flex;
    }

    /* Экран 1 и 2 – вертикальное выравнивание */
    #mainScreen,
    #appsScreen {
      justify-content: center;
      align-items: center;
    }

    .inner-container {
      width: 100%;
      margin: 0;
      padding: 0;
      text-align: left;
    }

    .inner-container h1 {
      font-size: 20px;
      font-weight: 50;
      color: #007aff;
      margin-bottom: 16px;
      padding: 0 12px;
    }

    .buttons-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .os-button {
      font-size: 19px;
      font-family: 'SF-Pro-Display-Regular';
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #2c2c2e;
      border-radius: 8px;
      text-decoration: none;
      color: #fff;
      padding: 12px;
      margin-left: 10px;
      height: 47px;
      width: 97%;
    }
    .os-button:hover {
      background-color: #3a3a3c;
    }

    .os-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .os-icon-wrap {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .ios-bg { background-color: #fff; }
    .ios-bg img { width: 22px; height: 22px; }
    .android-bg { background-color: #fb1c1c; }
    .android-bg img { width: 22px; height: 22px; }
    .macos-bg { background-color: #000; }
    .macos-bg img { width: 24px; height: auto; }
    .windows-bg { background-color: #fff; }
    .windows-bg img { width: 22px; height: 22px; }
    .linux-bg { background-color: #f7b824; }
    .linux-bg img { width: 23px; height: 23px; }

    .arrow-icon {
      width: 11px;
      height: 13px;
      margin-right: 12px;
    }
    .arrow-icon path {
      fill: none;
      stroke: #888;
      stroke-width: 1.2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* Все экраны с инструкциями */
    .centered-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: calc(100% - 100px);
      text-align: center;
      padding: 16px;
      box-sizing: border-box;
    }

    .instruction-line {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      width: 80%;
      max-width: 500px;
      margin: 12px 0;
      font-size: 22px;
      text-align: left;
      white-space: normal;
    }
    .instruction-line::before {
      content: attr(data-number);
      color: #888;
      margin-right: 8px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .download-button-container {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
    }
    .download-button {
      font-family: 'SF-Pro-Display-Medium';
      display: block;
      background: #fff;
      color: #000;
      text-decoration: none;
      font-size: 18px;
      padding: 16px 28px;
      border-radius: 18px;
      width: 80%;
      height: 10%;
      max-height: 70px;
      max-width: 500px;
      text-align: center;
    }
    .download-button:hover {
      opacity: 0.8;
    }

    code {
      background: #2c2c2e;
      padding: 4px 6px;
      border-radius: 4px;
      color: #fff;
      font-family: Consolas, monospace;
      font-size: 0.9rem;
      display: inline-block;
      cursor: pointer;
    }

    /* Иконки приложений */
    .os-icon-wrap img.hiddify-icon { width: 25px; height: 25px; }
    .os-icon-wrap img.foxray-icon  { width: 20px; height: 20px; }
    .os-icon-wrap img.nekobox-icon { width: 28px; height: 28px; }
    .os-icon-wrap img.nekoray-icon { width: 25px; height: auto; }

    /* Цветные фоны для апп-иконок */
    .hiddify-bg { background: #F0F0F0; }
    .foxray-bg  { background-color: #007aff; }
    .nekobox-bg { background-color: #fff; }
    .nekoray-bg { background-color: #D3D3D3; }
  </style>
</head>
<body>
<div id="loader">
  <img src="Cloud With Lightning.webp" alt="Loading...">
</div>

<div id="appWrapper">
  <!-- Экран 1: Выбор ОС -->
  <div id="mainScreen" class="screen">
    <div class="inner-container">
      <h1>Выберите операционную систему</h1>
      <div class="buttons-container">
        <!-- iOS -->
        <a href="#" class="os-button" data-os="iOS">
          <div class="os-left">
            <div class="os-icon-wrap ios-bg">
              <img src="https://www.svgrepo.com/show/473543/apple.svg" alt="iOS">
            </div>
            <span>iOS</span>
          </div>
          <svg class="arrow-icon" viewBox="0 0 6 8" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1 L5 4 L1 7" />
          </svg>
        </a>
        <!-- Android -->
        <a href="#" class="os-button" data-os="Android">
          <div class="os-left">
            <div class="os-icon-wrap android-bg">
              <img src="https://www.svgrepo.com/show/475631/android-color.svg" alt="Android">
            </div>
            <span>Android</span>
          </div>
          <svg class="arrow-icon" viewBox="0 0 6 8" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1 L5 4 L1 7" />
          </svg>
        </a>
        <!-- MacOS -->
        <a href="#" class="os-button" data-os="MacOS">
          <div class="os-left">
            <div class="os-icon-wrap macos-bg">
              <img src="https://img.icons8.com/color/48/mac-logo.png" alt="macOS">
            </div>
            <span>MacOS</span>
          </div>
          <svg class="arrow-icon" viewBox="0 0 6 8" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1 L5 4 L1 7" />
          </svg>
        </a>
        <!-- Windows -->
        <a href="#" class="os-button" data-os="Windows">
          <div class="os-left">
            <div class="os-icon-wrap windows-bg">
              <img src="https://www.svgrepo.com/show/382713/windows-applications.svg" alt="Windows">
            </div>
            <span>Windows</span>
          </div>
          <svg class="arrow-icon" viewBox="0 0 6 8" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1 L5 4 L1 7" />
          </svg>
        </a>
        <!-- Linux -->
        <a href="#" class="os-button" data-os="Linux">
          <div class="os-left">
            <div class="os-icon-wrap linux-bg">
              <img src="https://upload.wikimedia.org/wikipedia/commons/3/35/Tux.svg" alt="Linux">
            </div>
            <span>Linux</span>
          </div>
          <svg class="arrow-icon" viewBox="0 0 6 8" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1 L5 4 L1 7" />
          </svg>
        </a>
      </div>
    </div>
  </div>

  <!-- Экран 2: Выбор приложения -->
  <div id="appsScreen" class="screen">
    <div class="inner-container">
      <h1>Выберите приложение</h1>
      <div class="buttons-container" id="appsList"></div>
    </div>
  </div>

  <!-- Экран 3: Инструкция для Hiddify -->
  <div id="hiddifyScreen" class="screen">
    <div class="centered-content">
      <div class="instruction-line" data-number="1">
        <span>Скачайте приложение Hiddify;</span>
      </div>
      <div class="instruction-line" data-number="2">
        <span>Нажмите кнопку «⚡ Подключиться» в главном меню бота.</span>
      </div>
    </div>
    <div class="download-button-container">
      <a href="https://hiddify.com/" target="_blank" class="download-button">Скачать</a>
    </div>
  </div>

  <!-- Экран FoXray (iOS/Mac) -->
  <div id="foXrayScreen" class="screen">
    <div class="centered-content">
      <div class="instruction-line" data-number="1">
        <span>Получите и скопируйте ключ в боте;</span>
      </div>
      <div class="instruction-line" data-number="2">
        <span>Скачайте и откройте приложение FoXray;</span>
      </div>
      <div class="instruction-line" data-number="3">
        <span>Нажмите иконку «Вставить» в правом верхнем углу;</span>
      </div>
      <div class="instruction-line" data-number="4">
        <span>В отобразившемся окне нажмите «Разрешить вставку»;</span>
      </div>
      <div class="instruction-line" data-number="5">
        <span>Разрешите FoXray добавить конфигурацию VPN;</span>
      </div>
      <div class="instruction-line" data-number="6">
        <span>Нажмите на кнопку запуска напротив добавленного VPN.</span>
      </div>
    </div>
    <div class="download-button-container">
      <a href="https://apps.apple.com/ru/app/foxray/id6448898396" target="_blank" class="download-button">
        Скачать
      </a>
    </div>
  </div>

  <!-- Экран NekoBox (Android) -->
  <div id="nekoBoxScreen" class="screen">
    <div class="centered-content">
      <div class="instruction-line" data-number="1">
        <span>Получите и скопируйте ключ в боте;</span>
      </div>
      <div class="instruction-line" data-number="2">
        <span>Скачайте приложение NekoBox;</span>
      </div>
      <div class="instruction-line" data-number="3">
        <span>Откройте папку загрузок или нажмите «Скачанные файлы» в браузере;</span>
      </div>
      <div class="instruction-line" data-number="4">
        <span>Нажмите на скачанный файл и нажмите «Установить»;</span>
      </div>
      <div class="instruction-line" data-number="5">
        <span>Откройте установленное приложение и выдайте разрешение;</span>
      </div>
      <div class="instruction-line" data-number="6">
        <span>Нажмите на иконку «Вставить» → «Импорт из буфера обмена»;</span>
      </div>
      <div class="instruction-line" data-number="7">
        <span>Выберете конфигурацию и нажмите на иконку запуска;</span>
      </div>
      <div class="instruction-line" data-number="8">
        <span>Выдайте разрешение, если требуется.</span>
      </div>
    </div>
    <div class="download-button-container">
      <a href="https://github.com/MatsuriDayo/NekoBoxForAndroid/releases/download/1.2.9/NB4A-1.2.9-arm64-v8a.apk"
         target="_blank" class="download-button">
        Скачать
      </a>
    </div>
  </div>

  <!-- Экран Nekoray (Windows) -->
  <div id="nekorayScreen" class="screen">
    <div class="centered-content">
      <div class="instruction-line" data-number="1">
        <span>Получите и скопируйте ключ в боте;</span>
      </div>
      <div class="instruction-line" data-number="2">
        <span>Скачайте .zip архив с приложением;</span>
      </div>
      <div class="instruction-line" data-number="3">
        <span>Распакуйте архив в удобное место (C или D);</span>
      </div>
      <div class="instruction-line" data-number="4">
        <span>Откройте папку Nekoray и запустите <b>nekoray.exe</b>;</span>
      </div>
      <div class="instruction-line" data-number="5">
        <span>Если появится всплывающее окно — выберите xray;</span>
      </div>
      <div class="instruction-line" data-number="6">
        <span>Если окно не открылось, проверьте системный трей;</span>
      </div>
      <div class="instruction-line" data-number="7">
        <span>Нажмите «Программа» → «Добавить профиль из буфера обмена»;</span>
      </div>
      <div class="instruction-line" data-number="8">
        <span>Отметьте «Режим системного прокси» и «Режим TUN»;</span>
      </div>
      <div class="instruction-line" data-number="9">
        <span>Кликните по VPN правой кнопкой → «Запустить»/«Остановить» или используйте иконку в трее.</span>
      </div>
    </div>
    <div class="download-button-container">
      <a href="https://github.com/MatsuriDayo/nekoray/releases/download/3.26/nekoray-3.26-2023-12-09-windows64.zip"
         target="_blank" class="download-button">
        Скачать
      </a>
    </div>
  </div>

  <!-- Экран Nekoray (Linux) -->
  <div id="nekorayLinuxScreen" class="screen">
    <div class="centered-content">
      <div class="instruction-line" data-number="1">
        <span>Получите и скопируйте ключ в боте;</span>
      </div>
      <div class="instruction-line" data-number="2">
        <span>Скачайте .deb файл приложения;</span>
      </div>
      <div class="instruction-line" data-number="3">
        <span>В терминале:</span><br>
        <code id="copyCmd">
          sudo apt install ./nekoray-*-debian-x64.deb
        </code>
      </div>
      <div class="instruction-line" data-number="4">
        <span>Запустите Nekoray;</span>
      </div>
      <div class="instruction-line" data-number="5">
        <span>Если нет окна — проверьте системный трей;</span>
      </div>
      <div class="instruction-line" data-number="6">
        <span>«Program» → «Add profile from clipboard»;</span>
      </div>
      <div class="instruction-line" data-number="7">
        <span>Отметьте «System Proxy» и «TUN Mode»;</span>
      </div>
      <div class="instruction-line" data-number="8">
        <span>Далее пользуйтесь через системный трей.</span>
      </div>
    </div>
    <div class="download-button-container">
      <a href="https://github.com/MatsuriDayo/nekoray/releases/download/3.26/nekoray-3.26-2023-12-09-debian-x64.deb"
         target="_blank" class="download-button">
        Скачать
      </a>
    </div>
  </div>
</div>

<script>
  // Telegram WebApp API: оповещаем, что всё загрузилось
  Telegram.WebApp.ready();

  // Можно установить цвет заголовка (по желанию)
  Telegram.WebApp.setHeaderColor('theme'); // или 'bg_color' / любой hex

  // Скрыть основную кнопку Telegram (если вдруг у вас нет нужды в ней)
  Telegram.WebApp.MainButton.hide();
  
  // По умолчанию скрываем кнопку «Назад» (будем показывать её вручную)
  Telegram.WebApp.BackButton.hide();

  // Логика "смены экранов" с историей для Telegram-кнопки "Назад"
  const historyStack = [];
  let currentScreen = null;

  function showScreen(screen) {
    // Если уже есть экран, прячем и добавляем в "историю"
    if (currentScreen && currentScreen !== screen) {
      currentScreen.classList.remove('active');
      historyStack.push(currentScreen);
    }
    // Показываем новый
    currentScreen = screen;
    currentScreen.classList.add('active');

    // Если есть «предыдущий» экран в стеке, показываем телеграм-кнопку
    if (historyStack.length > 0) {
      Telegram.WebApp.BackButton.show();
    } else {
      // Если мы на главном экране (стек пуст), скрываем телеграм-кнопку
      Telegram.WebApp.BackButton.hide();
    }
  }

  // Отслеживаем клик по «телеграмовской» кнопке "Назад"
  Telegram.WebApp.onEvent('backButtonClicked', () => {
    if (historyStack.length > 0) {
      // Прячем текущий
      currentScreen.classList.remove('active');
      // Достаём предыдущий из historyStack
      const prevScreen = historyStack.pop();
      // Показываем предыдущий
      currentScreen = prevScreen;
      currentScreen.classList.add('active');

      // Если после возврата стэк ещё не пуст, показываем кнопку
      if (historyStack.length > 0) {
        Telegram.WebApp.BackButton.show();
      } else {
        Telegram.WebApp.BackButton.hide();
      }
    }
  });

  // ----- ЛОГИКА ЗАГРУЗЧИКА -----
  const loader = document.getElementById('loader');
  // 2-4 сек для рандомной задержки
  const randomTime = Math.floor(Math.random() * (4000 - 2000 + 1)) + 2000;
  setTimeout(() => {
    loader.style.opacity = '0';
    setTimeout(() => {
      loader.style.display = 'none';
      // Показать стартовый экран
      showScreen(document.getElementById('mainScreen'));
    }, 400);
  }, randomTime);

  // ----- КОНФИГ ПРИЛОЖЕНИЙ ДЛЯ КАЖДОЙ ОС -----
  const appsForOS = {
    iOS:     ["Hiddify", "FoXray"],
    Android: ["Hiddify", "NekoBox"],
    MacOS:   ["Hiddify", "FoXray"],
    Windows: ["Hiddify", "Nekoray"],
    Linux:   ["Hiddify", "Nekoray"]
  };

  const appsIcons = {
    "Hiddify": "https://www.85la.com/wp-content/uploads/replace/288cae51aa43a8ee1076d7fd49eb87bc.png",
    "FoXray":  "https://play-lh.googleusercontent.com/BPhvna2GxvfbpPKRjlzG-CD3Va8ti2bZ1er7eSVcieBG-jOW-H_cn5PYpX5K0u-UlWU",
    "NekoBox": "https://cs9f3b.4pda.ws/28766140.png",
    "Nekoray": "https://nekoray.com/wp-content/uploads/2024/04/nekoray.png"
  };

  // Элементы экранов
  const mainScreen      = document.getElementById('mainScreen');
  const appsScreen      = document.getElementById('appsScreen');
  const hiddifyScreen   = document.getElementById('hiddifyScreen');
  const foXrayScreen    = document.getElementById('foXrayScreen');
  const nekoBoxScreen   = document.getElementById('nekoBoxScreen');
  const nekorayScreen   = document.getElementById('nekorayScreen');
  const nekorayLinuxScr = document.getElementById('nekorayLinuxScreen');

  const appsList = document.getElementById('appsList');
  let currentOS = null;

  // Обработчики на кнопки выбора ОС (экран 1)
  document.querySelectorAll('.os-button[data-os]').forEach(btn => {
    btn.addEventListener('click', (ev) => {
      ev.preventDefault();
      currentOS = btn.getAttribute('data-os');
      appsList.innerHTML = '';

      // Генерируем список приложений для выбранной ОС
      appsForOS[currentOS].forEach(appName => {
        const a = document.createElement('a');
        a.className = 'os-button';
        a.href = '#';

        const leftDiv = document.createElement('div');
        leftDiv.className = 'os-left';

        const iconWrap = document.createElement('div');
        iconWrap.className = 'os-icon-wrap';

        if (appName === "Hiddify") {
          iconWrap.classList.add('hiddify-bg');
        } else if (appName === "FoXray") {
          iconWrap.classList.add('foxray-bg');
        } else if (appName === "NekoBox") {
          iconWrap.classList.add('nekobox-bg');
        } else if (appName === "Nekoray") {
          iconWrap.classList.add('nekoray-bg');
        }

        const img = document.createElement('img');
        img.src = appsIcons[appName] || "https://via.placeholder.com/24";
        img.alt = appName;

        if (appName === "Hiddify")  img.classList.add('hiddify-icon');
        if (appName === "FoXray")   img.classList.add('foxray-icon');
        if (appName === "NekoBox")  img.classList.add('nekobox-icon');
        if (appName === "Nekoray")  img.classList.add('nekoray-icon');

        iconWrap.appendChild(img);

        const spanApp = document.createElement('span');
        spanApp.textContent = appName;

        leftDiv.appendChild(iconWrap);
        leftDiv.appendChild(spanApp);

        const svgArrow = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svgArrow.setAttribute("viewBox","0 0 6 8");
        svgArrow.classList.add('arrow-icon');
        const pathArrow = document.createElementNS("http://www.w3.org/2000/svg", "path");
        pathArrow.setAttribute("d","M1 1 L5 4 L1 7");
        pathArrow.style.fill = 'none';
        pathArrow.style.stroke = '#888';
        pathArrow.style.strokeWidth = '1.2';
        pathArrow.style.strokeLinecap = 'round';
        pathArrow.style.strokeLinejoin = 'round';
        svgArrow.appendChild(pathArrow);

        a.appendChild(leftDiv);
        a.appendChild(svgArrow);

        // Обработчик клика по конкретному приложению
        a.addEventListener('click', (appEv) => {
          appEv.preventDefault();
          if (appName === "Hiddify") {
            showScreen(hiddifyScreen);
          } else if (appName === "FoXray") {
            showScreen(foXrayScreen);
          } else if (appName === "NekoBox") {
            showScreen(nekoBoxScreen);
          } else if (appName === "Nekoray") {
            if (currentOS === "Windows") {
              showScreen(nekorayScreen);
            } else if (currentOS === "Linux") {
              showScreen(nekorayLinuxScr);
            }
          } else {
            alert("Нажато приложение: " + appName);
          }
        });

        appsList.appendChild(a);
      });

      // Переход на экран 2
      showScreen(appsScreen);
    });
  });

  // Копирование команды в Linux-экране
  const copyCmd = document.getElementById('copyCmd');
  if (copyCmd) {
    copyCmd.addEventListener('click', () => {
      const textToCopy = copyCmd.textContent.trim();
      navigator.clipboard.writeText(textToCopy).then(() => {
        alert("Команда скопирована!");
      }, err => {
        console.error("Ошибка копирования:", err);
      });
    });
  }

  // Если нужно автоматически переносить текст с «серым остатком» — 
  // можно вызывать вашу handleTextOverflow() при load (убрано здесь для краткости).
</script>
</body>
</html>